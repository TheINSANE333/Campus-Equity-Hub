{% extends "layout.html" %}
{% block content %}
<div class="container">
    <h2 class="my-4">Campus Search</h2>
    
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    <h5>Find Your Campus</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <label for="campusSearch" class="form-label">Search for a campus:</label>
                        <div class="input-group mb-3">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="campusSearch" 
                                placeholder="Start typing campus name or location..." autocomplete="off">
                        </div>
                        <small class="text-muted">Search by campus name or location</small>
                    </div>
                    
                    <div id="searchResults" class="list-group mb-4" style="display: none;">
                        <!-- Search results will appear here -->
                    </div>
                    
                    <div id="selectedCampus" class="mt-4" style="display: none;">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h5 id="campusName">Campus Name</h5>
                            </div>
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted" id="campusLocation">Location</h6>
                                <p class="card-text" id="campusDescription">Description will appear here.</p>
                                <button class="btn btn-outline-primary" id="selectDifferentCampus">Select Different Campus</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Bootstrap Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css">

<!-- Add JavaScript for Campus Search functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('campusSearch');
    const searchResults = document.getElementById('searchResults');
    const selectedCampus = document.getElementById('selectedCampus');
    const campusName = document.getElementById('campusName');
    const campusLocation = document.getElementById('campusLocation');
    const campusDescription = document.getElementById('campusDescription');
    const selectDifferentCampus = document.getElementById('selectDifferentCampus');
    
    let timeoutId;
    
    // Handle input in search box
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Clear previous timeout
        clearTimeout(timeoutId);
        
        // Hide selected campus when searching
        selectedCampus.style.display = 'none';
        
        if (query.length < 0) {
            searchResults.style.display = 'none';
            searchResults.innerHTML = '';
            return;
        }
        
        // Set a timeout to prevent too many requests while typing
        timeoutId = setTimeout(function() {
            fetchSearchResults(query);
        }, 300);
    });
    
    // Fetch search results from API
    function fetchSearchResults(query) {
        fetch(`/api/campus-search?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                displaySearchResults(data);
            })
            .catch(error => {
                console.error('Error fetching search results:', error);
            });
    }
    
    // Display search results
    function displaySearchResults(results) {
        searchResults.innerHTML = '';
        
        if (results.length === 0) {
            searchResults.innerHTML = '<div class="list-group-item">No campuses found</div>';
            searchResults.style.display = 'block';
            return;
        }
        
        results.forEach(campus => {
            const item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action';
            item.innerHTML = `<strong>${highlightMatch(campus.name, searchInput.value)}</strong> - ${highlightMatch(campus.location, searchInput.value)}`;
            
            item.addEventListener('click', function(e) {
                e.preventDefault();
                selectCampus(campus.id);
            });
            
            searchResults.appendChild(item);
        });
        
        searchResults.style.display = 'block';
    }
    
    // Highlight matching text
    function highlightMatch(text, query) {
        if (!query) return text;
        
        const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return text.replace(regex, '<span class="text-primary">$1</span>');
    }
    
    // Select a campus
    function selectCampus(campusId) {
        fetch(`/api/campus/${campusId}`)
            .then(response => response.json())
            .then(campus => {
                // Set campus details
                campusName.textContent = campus.name;
                campusLocation.textContent = campus.location;
                campusDescription.textContent = campus.description;
                
                // Show selected campus and hide search results
                selectedCampus.style.display = 'block';
                searchResults.style.display = 'none';
                searchInput.value = '';
                
                // You could also store the selected campus ID in a hidden form field if needed
                // document.getElementById('selectedCampusId').value = campus.id;
            })
            .catch(error => {
                console.error('Error fetching campus details:', error);
            });
    }
    
    // Handle "Select Different Campus" button
    selectDifferentCampus.addEventListener('click', function() {
        selectedCampus.style.display = 'none';
        searchInput.value = '';
        searchInput.focus();
    });
    
    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });
});
</script>
{% endblock %}